<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HPP Admin Panel (Firebase Edition)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body{font-family:'Plus Jakarta Sans',sans-serif;background-color:#f8fafc}
        .loader{border:2px solid #e2e8f0;border-top:2px solid #4f46e5;border-radius:50%;width:14px;height:14px;animation:spin 1s linear infinite;display:inline-block}
        @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
        .animate-fade{animation:fadeIn 0.3s ease-in-out}
        @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
        /* TOAST ANIMATION */
        .toast-enter { animation: toastIn 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .toast-exit { animation: toastOut 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes toastIn { from { opacity: 0; transform: translate(-50%, 20px) scale(0.9); } to { opacity: 1; transform: translate(-50%, 0) scale(1); } }
        @keyframes toastOut { from { opacity: 1; transform: translate(-50%, 0) scale(1); } to { opacity: 0; transform: translate(-50%, 20px) scale(0.9); } }
    </style>
</head>
<body class="pb-24 text-slate-800 bg-slate-50">

    <nav class="fixed top-0 w-full bg-white/80 backdrop-blur-md z-40 border-b border-slate-200 px-4 py-3 flex justify-between items-center shadow-sm">
        <div class="flex items-center gap-3">
            <div class="w-9 h-9 bg-gradient-to-br from-indigo-600 to-indigo-500 rounded-xl flex items-center justify-center text-white shadow-lg shadow-indigo-500/30">
                <i class="fa-solid fa-shield-halved"></i>
            </div>
            <div>
                <h1 class="font-bold text-slate-800 leading-none">Admin Panel</h1>
                <p class="text-[10px] font-bold text-slate-400">Enterprise Manager</p>
            </div>
        </div>
        <div class="flex bg-slate-100 p-1 rounded-lg">
            <button onclick="window.switchTab('license')" id="btn-license" class="px-3 py-1.5 rounded-md text-[10px] font-bold bg-white shadow-sm text-indigo-600 transition">Lisensi</button>
            <button onclick="window.switchTab('monitor')" id="btn-monitor" class="px-3 py-1.5 rounded-md text-[10px] font-bold text-slate-500 hover:bg-slate-200 transition">Monitor</button>
        </div>
    </nav>

    <div class="max-w-md mx-auto pt-24 px-4 space-y-6 animate-fade">
        
        <div id="view-license">
            <div class="bg-white p-6 rounded-3xl shadow-xl shadow-slate-200/50 border border-slate-100 relative overflow-hidden group mb-6">
                <div class="absolute top-0 right-0 w-24 h-24 bg-indigo-50 rounded-full blur-2xl -mr-8 -mt-8 transition group-hover:bg-indigo-100"></div>
                <h2 class="font-bold text-slate-800 mb-5 flex items-center gap-2 relative z-10">
                    <i class="fa-solid fa-user-plus text-indigo-500"></i> Registrasi Tenant
                </h2>
                
                <div class="space-y-4 relative z-10">
                    <div>
                        <label class="text-[10px] font-bold uppercase text-slate-400 ml-1">Nama Client / Toko</label>
                        <input id="storeName" type="text" placeholder="Contoh: Kopi Senja" oninput="window.autoGenerate()" class="w-full bg-slate-50 border border-slate-200 p-3.5 rounded-xl font-bold text-sm outline-none focus:bg-white focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition mt-1">
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-[10px] font-bold uppercase text-slate-400 ml-1">ID (Username)</label>
                            <input id="tenantId" type="text" readonly class="w-full bg-slate-100 border border-slate-200 p-3.5 rounded-xl font-bold text-sm outline-none text-slate-500 mt-1 lowercase">
                        </div>
                        <div>
                            <label class="text-[10px] font-bold uppercase text-slate-400 ml-1">Password</label>
                            <div class="relative">
                                <input id="password" type="text" readonly class="w-full bg-slate-100 border border-slate-200 p-3.5 rounded-xl font-black text-sm outline-none text-indigo-600 mt-1 tracking-widest uppercase">
                                <button onclick="window.regeneratePass()" class="absolute right-2 top-2.5 text-slate-400 hover:text-indigo-600 p-1"><i class="fa-solid fa-rotate"></i></button>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <input type="hidden" id="licType" value="BASIC">
                        <div class="grid grid-cols-2 gap-3 mt-1">
                            <div onclick="window.selectLicType('BASIC')" id="card-BASIC" class="cursor-pointer relative p-3 rounded-xl border-2 border-slate-900 bg-white ring-2 ring-slate-100 transition-all duration-300 group">
                                <div class="flex items-center gap-2 mb-1">
                                    <i class="fa-solid fa-layer-group text-slate-500"></i> <span class="font-black text-sm text-slate-800">BASIC</span>
                                </div>
                                <div id="check-BASIC" class="absolute top-2 right-2 text-slate-900"><i class="fa-solid fa-circle-check"></i></div>
                            </div>
                            <div onclick="window.selectLicType('PRO')" id="card-PRO" class="cursor-pointer relative p-3 rounded-xl border border-slate-200 bg-slate-50 opacity-70 transition-all duration-300 group">
                                <div class="flex items-center gap-2 mb-1">
                                    <i class="fa-solid fa-crown text-amber-500"></i> <span class="font-black text-sm text-slate-800">PRO</span>
                                </div>
                                <div id="check-PRO" class="hidden absolute top-2 right-2 text-amber-500"><i class="fa-solid fa-circle-check"></i></div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="text-[10px] font-bold uppercase text-slate-400 ml-1">Masa Aktif</label>
                        <div class="flex gap-3 mt-1">
                            <input id="durationVal" type="number" value="1" class="w-20 text-center bg-slate-50 border border-slate-200 p-3.5 rounded-xl font-bold text-sm outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition">
                            <select id="durationUnit" class="flex-1 bg-slate-50 border border-slate-200 p-3.5 rounded-xl font-bold text-sm outline-none focus:border-indigo-500 cursor-pointer appearance-none focus:ring-2 focus:ring-indigo-200 transition">
                                <option value="month">Bulan</option>
                                <option value="year">Tahun</option>
                                <option value="day">Hari</option>
                            </select>
                        </div>
                    </div>

                    <button type="button" id="btnSave" class="w-full bg-slate-900 hover:bg-slate-800 text-white py-4 rounded-xl font-bold shadow-lg shadow-slate-900/20 active:scale-[0.98] transition flex items-center justify-center gap-2 mt-2">
                        <i class="fa-solid fa-database"></i> SIMPAN KE FIREBASE
                    </button>
                </div>
            </div>

            <div>
                <div class="flex justify-between items-center px-1 mb-3">
                    <h3 class="font-bold text-slate-400 text-xs uppercase tracking-wider flex items-center gap-2">
                        <i class="fa-solid fa-users"></i> Database Client
                    </h3>
                </div>
                <div id="clientList" class="space-y-3 pb-10">
                    <p class="text-center py-10 text-xs text-slate-400"><span class="loader border-slate-300 border-t-slate-500"></span> Memuat Data...</p>
                </div>
            </div>
        </div>

        <div id="view-monitor" class="hidden">
            <div class="bg-white p-6 rounded-3xl shadow-xl shadow-slate-200/50 border border-slate-100 relative overflow-hidden">
                <div class="flex justify-between items-center mb-5">
                    <h2 class="font-bold text-slate-800 flex items-center gap-2">
                        <i class="fa-solid fa-satellite-dish text-indigo-500"></i> Log Aktivitas
                    </h2>
                    <span class="text-[10px] font-bold bg-indigo-50 text-indigo-600 px-3 py-1 rounded-full animate-pulse">Live</span>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50 text-slate-400 text-[10px] uppercase font-bold border-b border-slate-100">
                            <tr><th class="p-3">Waktu</th><th class="p-3">User</th><th class="p-3">Device & IP</th></tr>
                        </thead>
                        <tbody id="logTable" class="text-xs">
                            <tr><td colspan="3" class="p-6 text-center text-slate-400 italic">Menunggu aktivitas...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, updateDoc, onSnapshot, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- KONFIGURASI FIREBASE ---
        // Tempel Config yang SAMA PERSIS dengan App.jsx di sini
        const firebaseConfig = {
            apiKey: "ISI_API_KEY_KAMU",
            authDomain: "PROJECT_ID.firebaseapp.com",
            projectId: "PROJECT_ID",
            storageBucket: "PROJECT_ID.appspot.com",
            messagingSenderId: "...",
            appId: "..."
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- LOGIC UI & GENERATOR ---
        
        window.autoGenerate = () => {
            const name = document.getElementById('storeName').value;
            if(!name) {
                document.getElementById('tenantId').value = "";
                document.getElementById('password').value = "";
                return;
            }
            // Logic ID: Huruf kecil, spasi jadi underscore, tambah angka acak dikit biar unik
            const cleanName = name.toLowerCase().replace(/[^a-z0-9]/g, '_');
            const randomSuffix = Math.floor(Math.random() * 100); 
            document.getElementById('tenantId').value = cleanName; 
            
            // Logic Password: Jika kosong, generate baru
            if(!document.getElementById('password').value) window.regeneratePass();
        };

        window.regeneratePass = () => {
            const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
            let pass = "";
            for (let i = 0; i < 6; i++) pass += chars.charAt(Math.floor(Math.random() * chars.length));
            document.getElementById('password').value = pass.slice(0,3) + "-" + pass.slice(3,6);
        };

        window.switchTab = (tab) => {
            const vLic = document.getElementById('view-license');
            const vMon = document.getElementById('view-monitor');
            const bLic = document.getElementById('btn-license');
            const bMon = document.getElementById('btn-monitor');

            if(tab === 'license') {
                vLic.classList.remove('hidden');
                vMon.classList.add('hidden');
                bLic.className = "px-3 py-1.5 rounded-md text-[10px] font-bold bg-white shadow-sm text-indigo-600 transition";
                bMon.className = "px-3 py-1.5 rounded-md text-[10px] font-bold text-slate-500 hover:bg-slate-200 transition";
            } else {
                vLic.classList.add('hidden');
                vMon.classList.remove('hidden');
                bMon.className = "px-3 py-1.5 rounded-md text-[10px] font-bold bg-white shadow-sm text-indigo-600 transition";
                bLic.className = "px-3 py-1.5 rounded-md text-[10px] font-bold text-slate-500 hover:bg-slate-200 transition";
            }
        };

        window.selectLicType = (type) => {
            document.getElementById('licType').value = type;
            const cardBasic = document.getElementById('card-BASIC');
            const cardPro = document.getElementById('card-PRO');
            const checkBasic = document.getElementById('check-BASIC');
            const checkPro = document.getElementById('check-PRO');

            if(type === 'BASIC') {
                cardBasic.className = "cursor-pointer relative p-3 rounded-xl border-2 border-slate-900 bg-white ring-2 ring-slate-100 transition-all duration-300 group";
                cardBasic.style.opacity = "1";
                checkBasic.classList.remove('hidden');
                cardPro.className = "cursor-pointer relative p-3 rounded-xl border border-slate-200 bg-slate-50 opacity-70 group hover:opacity-100";
                checkPro.classList.add('hidden');
            } else {
                cardBasic.className = "cursor-pointer relative p-3 rounded-xl border border-slate-200 bg-slate-50 opacity-70 group hover:opacity-100";
                checkBasic.classList.add('hidden');
                cardPro.className = "cursor-pointer relative p-3 rounded-xl border-2 border-amber-400 bg-gradient-to-br from-amber-50 to-yellow-50 shadow-lg shadow-amber-500/20 transition-all duration-300 group";
                cardPro.style.opacity = "1";
                checkPro.classList.remove('hidden');
            }
        };

        // --- FIREBASE: SIMPAN USER ---
        document.getElementById('btnSave').addEventListener('click', async () => {
            const btn = document.getElementById('btnSave');
            const id = document.getElementById('tenantId').value.trim();
            const pass = document.getElementById('password').value.trim();
            const name = document.getElementById('storeName').value.trim();
            const type = document.getElementById('licType').value;
            
            // LOGIC DURASI DIKEMBALIKAN KE ORIGINAL (SPLIT VALUE & UNIT)
            const val = parseInt(document.getElementById('durationVal').value);
            const unit = document.getElementById('durationUnit').value;

            if(!id || !pass || !name) return alert("Data belum lengkap!");

            btn.innerHTML = '<span class="loader border-white/20 border-t-white"></span> Menyimpan...';
            btn.disabled = true;

            const date = new Date();
            if(unit === 'month') date.setMonth(date.getMonth() + val);
            if(unit === 'year') date.setFullYear(date.getFullYear() + val);
            if(unit === 'day') date.setDate(date.getDate() + val);

            try {
                await setDoc(doc(db, "licenses", id), {
                    id: id,
                    password: pass,
                    tenant: name,
                    type: type,
                    active: true,
                    validUntil: date.toISOString(),
                    createdAt: new Date().toISOString()
                });
                showToast(`Tenant ${name} Berhasil Didaftarkan!`);
                document.getElementById('storeName').value = '';
                document.getElementById('tenantId').value = '';
                document.getElementById('password').value = '';
            } catch (e) {
                alert("Error: " + e.message);
            } finally {
                btn.innerHTML = '<i class="fa-solid fa-database"></i> SIMPAN KE FIREBASE';
                btn.disabled = false;
            }
        });

        // --- FIREBASE: LIST USER REALTIME ---
        onSnapshot(query(collection(db, "licenses"), orderBy("createdAt", "desc")), (snapshot) => {
            const container = document.getElementById('clientList');
            container.innerHTML = '';
            if(snapshot.empty) {
                container.innerHTML = `<div class="text-center py-10 opacity-50"><p class="text-xs text-slate-400">Belum ada client.</p></div>`;
                return;
            }

            snapshot.forEach(docSnap => {
                const c = docSnap.data();
                const isActive = c.active;
                
                const badge = isActive 
                    ? '<span class="text-emerald-600 bg-emerald-50 px-2 py-0.5 rounded text-[9px] font-black border border-emerald-100 uppercase tracking-wide"><i class="fa-solid fa-check mr-1"></i>AKTIF</span>'
                    : '<span class="text-rose-600 bg-rose-50 px-2 py-0.5 rounded text-[9px] font-black border border-rose-100 uppercase tracking-wide"><i class="fa-solid fa-ban mr-1"></i>SUSPEND</span>';

                const actionBtn = isActive 
                    ? `<button onclick="window.toggleStatus('${c.id}', false)" class="flex-1 bg-white border border-rose-200 text-rose-500 hover:bg-rose-50 py-2.5 rounded-lg text-[10px] font-bold transition">MATIKAN AKSES</button>`
                    : `<button onclick="window.toggleStatus('${c.id}', true)" class="flex-1 bg-emerald-500 hover:bg-emerald-600 text-white py-2.5 rounded-lg text-[10px] font-bold shadow-md shadow-emerald-500/20 transition">BUKA AKSES</button>`;

                const html = `
                <div class="p-4 rounded-2xl shadow-sm border bg-white border-slate-100 hover:border-indigo-200 transition group">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h4 class="font-bold text-slate-800 text-sm flex items-center gap-2">${c.tenant} <span class="text-[9px] px-1.5 py-0.5 rounded bg-slate-100 text-slate-500 border border-slate-200">${c.type}</span></h4>
                            <p class="text-[10px] text-slate-400 mt-0.5 pl-0">ID: <span class="font-bold text-indigo-500">${c.id}</span></p>
                        </div>
                        ${badge}
                    </div>
                    <div class="bg-slate-50 p-2 rounded-xl border border-slate-100 mb-4 flex justify-between items-center">
                        <span class="text-[10px] font-bold text-slate-400">PASSWORD</span>
                        <div class="flex gap-2 items-center">
                            <span class="font-mono font-black text-slate-800 text-sm tracking-widest">${c.password}</span>
                            <button onclick="window.copyText('${c.password}')" class="text-slate-400 hover:text-indigo-600"><i class="fa-regular fa-copy"></i></button>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        ${actionBtn}
                        <button onclick="window.del('${c.id}')" class="w-10 bg-slate-100 rounded-lg text-slate-400 hover:text-rose-500 hover:bg-rose-50 border border-transparent hover:border-rose-200 transition"><i class="fa-solid fa-trash-can"></i></button>
                    </div>
                </div>`;
                container.innerHTML += html;
            });
        });

        // --- FIREBASE: LOGS MONITORING (PENGGANTI GOOGLE SCRIPT) ---
        onSnapshot(query(collection(db, "logs"), orderBy("timestamp", "desc"), limit(50)), (snapshot) => {
            const tbody = document.getElementById('logTable');
            tbody.innerHTML = '';
            
            if(snapshot.empty) {
                tbody.innerHTML = `<tr><td colspan="3" class="p-6 text-center text-slate-400 italic">Belum ada aktivitas login.</td></tr>`;
                return;
            }

            snapshot.forEach(docSnap => {
                const log = docSnap.data();
                const time = new Date(log.timestamp).toLocaleTimeString();
                
                const row = `
                <tr class="border-b border-slate-50 hover:bg-slate-50 transition">
                    <td class="p-3 text-slate-400 font-mono">${time}</td>
                    <td class="p-3">
                        <div class="font-bold text-slate-800 text-xs">${log.tenant}</div>
                        <div class="text-[9px] text-indigo-500 font-bold">${log.id}</div>
                    </td>
                    <td class="p-3">
                        <div class="font-mono text-slate-600 text-[10px]">${log.ip || 'IP Hidden'}</div>
                        <div class="text-[9px] text-slate-400 truncate max-w-[120px]">${log.device}</div>
                    </td>
                </tr>`;
                tbody.innerHTML += row;
            });
        });

        // --- GLOBAL HELPERS ---
        window.toggleStatus = async (id, status) => {
            await updateDoc(doc(db, "licenses", id), { active: status });
        };
        window.del = async (id) => {
            if(confirm("Hapus permanen?")) await deleteDoc(doc(db, "licenses", id));
        };
        window.copyText = (text) => {
            navigator.clipboard.writeText(text);
            showToast("Password Disalin!");
        };
        function showToast(msg) {
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-10 left-1/2 z-[100] flex items-center gap-3 bg-slate-900/90 backdrop-blur-md text-white px-6 py-3 rounded-full shadow-2xl toast-enter';
            toast.innerHTML = `<i class="fa-solid fa-check text-emerald-400"></i> <span class="text-sm font-bold">${msg}</span>`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2500);
        }
    </script>
</body>
</html>
